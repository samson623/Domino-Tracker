<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Domino Game Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        /* Dark mode base styles */
        .dark {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        
        .dark body {
            background-color: #1f2937;
        }
        
        .domino-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .domino-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .dark .domino-card {
            background: #374151;
            color: #f3f4f6;
        }
        
        .dark .bg-gray-50 {
            background-color: #4b5563;
        }
        
        .dark .bg-gray-100 {
            background-color: #1f2937;
        }
        
        .dark .bg-gray-200 {
            background-color: #4b5563;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af;
        }
        
        .dark .text-gray-600 {
            color: #d1d5db;
        }
        
        .dark .text-gray-700 {
            color: #e5e7eb;
        }
        
        .dark .border {
            border-color: #4b5563;
        }
        
        .dark .border-gray-600 {
            border-color: #4b5563;
        }
        
        /* Dark mode input styles */
        .dark input,
        .dark select {
            background-color: #4b5563;
            color: #f3f4f6;
            border-color: #6b7280;
        }
        
        .dark input::placeholder {
            color: #9ca3af;
        }
        
        .dark option {
            background-color: #4b5563;
            color: #f3f4f6;
        }
        
        .score-btn {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .score-btn:hover:not(:disabled) {
            transform: scale(1.05);
            border-color: #3B82F6;
        }
        
        .score-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .petaroll-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .petarolled-badge {
            background: linear-gradient(45deg, #DC2626, #991B1B);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .petaroll-alert {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .animate-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .game-item:hover .delete-game-btn {
            opacity: 1;
        }

        .delete-game-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .game-item:hover .edit-game-btn {
            opacity: 1;
        }

        .edit-game-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .game-mode-btn {
            transition: all 0.3s ease;
        }
        
        .game-mode-btn.active {
            background-color: #3B82F6;
            color: white;
            transform: scale(1.05);
        }

        /* Style for active desktop nav button */
        .nav-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
            color: #3B82F6;
        }

        /* Style for active mobile nav button */
        .mobile-nav-btn.active {
            color: #3B82F6;
            background-color: #e5e7eb; /* Light gray background */
            border-radius: 8px;
        }

        .dark .mobile-nav-btn.active {
            color: #60a5fa; /* Lighter blue for dark mode */
            background-color: #374151; /* Contrasting dark gray */
        }
        
        /* Custom score input styles */
        .custom-score-input {
            width: 100px;
            text-align: center;
            font-weight: bold;
        }
        
        /* Style for the add/subtract buttons */
        .custom-score-input::-webkit-inner-spin-button,
        .custom-score-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .custom-score-input {
            -moz-appearance: textfield;
        }

        #achievementToast, #toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10B981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        /* Custom Scrollbar for Achievements */
        #achievementsList::-webkit-scrollbar {
          width: 6px;
        }
        #achievementsList::-webkit-scrollbar-track {
          background: transparent;
        }
        #achievementsList::-webkit-scrollbar-thumb {
          background-color: #a0aec0;
          border-radius: 20px;
        }
        .dark #achievementsList::-webkit-scrollbar-thumb {
          background-color: #4a5568;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <!-- Navigation -->
    <nav class="domino-bg text-white p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-dice-six text-2xl"></i>
                <h1 class="text-xl font-bold">Domino Tracker</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showExportModal()" class="p-2 rounded-lg bg-green-600 hover:bg-green-700 transition" title="Export Data">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="showResetModal()" class="p-2 rounded-lg bg-red-600 hover:bg-red-700 transition" title="Reset All Data">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="themeToggle" class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="hidden md:flex space-x-2">
                    <button onclick="showSection('home')" data-section="home" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-home mr-1"></i>Home
                    </button>
                    <button onclick="showSection('live')" data-section="live" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-play mr-1"></i>Live Game
                    </button>
                    <button onclick="showSection('players')" data-section="players" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-user-plus mr-1"></i>Players
                    </button>
                    <button onclick="showSection('teams')" data-section="teams" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-users mr-1"></i>Teams
                    </button>
                    <button onclick="showSection('leaderboard')" data-section="leaderboard" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-trophy mr-1"></i>Leaderboard
                    </button>
                    <button onclick="showSection('history')" data-section="history" class="nav-btn px-3 py-1 rounded-lg hover:bg-white hover:bg-opacity-20">
                        <i class="fas fa-list mr-1"></i>History
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div class="md:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 fixed bottom-0 left-0 right-0 z-50">
        <div class="flex justify-around py-2">
            <button onclick="showSection('home')" data-section="home" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-home text-lg"></i>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="showSection('live')" data-section="live" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-play text-lg"></i>
                <span class="text-xs">Live</span>
            </button>
             <button onclick="showSection('players')" data-section="players" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-user-plus text-lg"></i>
                <span class="text-xs">Players</span>
            </button>
            <button onclick="showSection('teams')" data-section="teams" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-users text-lg"></i>
                <span class="text-xs">Teams</span>
            </button>
            <button onclick="showSection('leaderboard')" data-section="leaderboard" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-trophy text-lg"></i>
                <span class="text-xs">Stats</span>
            </button>
            <button onclick="showSection('history')" data-section="history" class="mobile-nav-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-100">
                <i class="fas fa-list text-lg"></i>
                <span class="text-xs">History</span>
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 pb-20">
        <!-- Home Section -->
        <div id="homeSection" class="section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Today's Performance -->
                <div class="domino-card p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                        Today's Performance
                    </h3>
                    <div id="todaysPerformance" class="space-y-3">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="domino-card p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                        Quick Actions
                    </h3>
                    <div class="space-y-3">
                        <button onclick="startNewGame()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-medium">
                            <i class="fas fa-play mr-2"></i>Start New Game
                        </button>
                        <button onclick="showSection('players')" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-medium">
                            <i class="fas fa-user-plus mr-2"></i>Add Player
                        </button>
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                        <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
                            <i class="fas fa-star mr-1"></i>PETAROLL: 75-0 or 150-&lt;75 = 2 wins!
                        </p>
                    </div>
                </div>

                <!-- Recent Games -->
                <div class="domino-card p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-purple-500"></i>
                        Recent Games
                    </h3>
                    <div id="recentGames" class="space-y-2">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Achievements -->
                <div class="domino-card p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-award mr-2 text-green-500"></i>
                        Achievements
                    </h3>
                    <div id="achievementsList" class="space-y-3 text-sm max-h-60 overflow-y-auto pr-2">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- Daily Player Summary -->
            <div class="domino-card p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-user-check mr-2 text-indigo-500"></i>
                    Daily Player Summary
                </h3>
                <div id="dailyPlayerSummaryList" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Live Game Section -->
        <div id="liveSection" class="section hidden">
            <div class="max-w-4xl mx-auto">
                <!-- Game Mode Selection -->
                <div class="domino-card p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 text-center">Select Game Mode</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="selectGameMode('team')" id="teamModeBtn" class="game-mode-btn p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 transition">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <h3 class="text-lg font-bold">Team vs Team</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">2 vs 2 players</p>
                        </button>
                        <button onclick="selectGameMode('single')" id="singleModeBtn" class="game-mode-btn p-6 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-500 transition">
                            <i class="fas fa-user text-3xl mb-2"></i>
                            <h3 class="text-lg font-bold">One on One</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">1 vs 1 player</p>
                        </button>
                    </div>
                </div>

                <!-- Game Setup -->
                <div id="gameSetup" class="domino-card p-6 mb-6 hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center">Setup New Game</h2>
                    
                    <!-- Team Mode Setup -->
                    <div id="teamModeSetup" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-center">Team 1</h3>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Team or Player 1</label>
                                    <select id="gameTeam1Selection" class="w-full p-3 border rounded-lg" onchange="handleTeamSelection('team1', this.value)">
                                        <option value="">Select team or player</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Player 1</label>
                                    <select id="gameTeam1Player1Input" class="w-full p-3 border rounded-lg"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Player 2</label>
                                    <select id="gameTeam1Player2Input" class="w-full p-3 border rounded-lg"></select>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-center">Team 2</h3>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Select Team or Player 1</label>
                                    <select id="gameTeam2Selection" class="w-full p-3 border rounded-lg" onchange="handleTeamSelection('team2', this.value)">
                                        <option value="">Select team or player</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Player 1</label>
                                    <select id="gameTeam2Player1Input" class="w-full p-3 border rounded-lg"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Player 2</label>
                                    <select id="gameTeam2Player2Input" class="w-full p-3 border rounded-lg"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Single Mode Setup -->
                    <div id="singleModeSetup" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Player 1 Name</label>
                                <select id="player1Select" class="w-full p-3 border rounded-lg">
                                    <option value="">Select player</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Player 2 Name</label>
                                <select id="player2Select" class="w-full p-3 border rounded-lg">
                                    <option value="">Select player</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Best Of Selection -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">Match Length</label>
                        <select id="bestOfSelect" class="w-full p-3 border rounded-lg">
                            <option value="1">Single Game</option>
                            <option value="3">Best of 3</option>
                            <option value="5">Best of 5</option>
                        </select>
                    </div>
                    
                    <button onclick="startGame()" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-bold text-lg">
                        <i class="fas fa-flag-checkered mr-2"></i>Start Game to 150!
                    </button>
                </div>

                <!-- Live Game Interface -->
                <div id="liveGame" class="hidden">
                    <!-- PETAROLL Alert -->
                    <div id="petarollAlert" class="hidden mb-4 p-4 bg-orange-100 dark:bg-orange-900 rounded-lg text-center">
                        <p class="text-lg font-bold text-orange-800 dark:text-orange-200">
                            <i class="fas fa-fire mr-2"></i>PETAROLL ALERT! Game will end at 75-0!<i class="fas fa-fire ml-2"></i>
                        </p>
                    </div>

                    <!-- Match Score -->
                    <div id="matchScore" class="text-center font-bold text-lg mb-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Team 1 Score -->
                        <div class="domino-card p-6">
                            <div class="text-center">
                                <div id="team1Players" class="text-xl font-bold mb-4"></div>
                                <div class="text-6xl font-bold mb-4" id="team1Score">0</div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-4">
                                    <div id="team1Progress" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="grid grid-cols-4 gap-2 mb-4">
                                    <button onclick="addScore(1, 5)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+5</button>
                                    <button onclick="addScore(1, 10)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+10</button>
                                    <button onclick="addScore(1, 15)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+15</button>
                                    <button onclick="addScore(1, 20)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+20</button>
                                    <button onclick="addScore(1, 25)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+25</button>
                                    <button onclick="addScore(1, 30)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+30</button>
                                    <button onclick="addScore(1, 35)" class="score-btn bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">+35</button>
                                    <button onclick="undoScore(1)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                                <!-- Custom score input -->
                                <div class="flex justify-center items-center space-x-2 mt-2">
                                    <button onclick="subtractCustomScore(1)" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg font-bold">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" id="customScore1" class="custom-score-input p-2 border rounded-lg" placeholder="Custom" min="-150" max="150">
                                    <button onclick="addCustomScore(1)" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg font-bold">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Team 2 Score -->
                        <div class="domino-card p-6">
                            <div class="text-center">
                                <div id="team2Players" class="text-xl font-bold mb-4"></div>
                                <div class="text-6xl font-bold mb-4" id="team2Score">0</div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-4">
                                    <div id="team2Progress" class="bg-red-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <div class="grid grid-cols-4 gap-2 mb-4">
                                    <button onclick="addScore(2, 5)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+5</button>
                                    <button onclick="addScore(2, 10)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+10</button>
                                    <button onclick="addScore(2, 15)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+15</button>
                                    <button onclick="addScore(2, 20)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+20</button>
                                    <button onclick="addScore(2, 25)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+25</button>
                                    <button onclick="addScore(2, 30)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+30</button>
                                    <button onclick="addScore(2, 35)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">+35</button>
                                    <button onclick="undoScore(2)" class="score-btn bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                                <!-- Custom score input -->
                                <div class="flex justify-center items-center space-x-2 mt-2">
                                    <button onclick="subtractCustomScore(2)" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg font-bold">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" id="customScore2" class="custom-score-input p-2 border rounded-lg" placeholder="Custom" min="-150" max="150">
                                    <button onclick="addCustomScore(2)" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg font-bold">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Controls -->
                    <div class="domino-card p-6 text-center">
                        <div id="gameControls" class="flex justify-center space-x-4">
                            <button onclick="endGame()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg">
                                <i class="fas fa-stop mr-2"></i>End Game
                            </button>
                            <button onclick="resetGame()" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-6 rounded-lg">
                                <i class="fas fa-sync mr-2"></i>Reset
                            </button>
                             <button id="micBtn" onclick="toggleMic()" class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-6 rounded-lg transition-all">
                                 <i class="fas fa-microphone mr-2"></i>Voice
                             </button>
                        </div>
                        <div id="confirmScoreContainer" class="hidden mt-4">
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="confirmScoreBtn" class="w-full sm:w-2/3 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-bold text-lg animate-pulse">
                                    <i class="fas fa-check-double mr-2"></i>Confirm Final Score
                                </button>
                                <button id="correctScoreBtn" class="w-full sm:w-1/3 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg font-medium">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                            </div>
                        </div>
                        <div id="voiceOutput" class="mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
                    </div>

                    <!-- Turn Timer -->
                    <div class="domino-card p-6 mt-6 text-center">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Turn Time Limit (seconds, max 60)</label>
                            <input type="number" id="turnTimeInput" class="w-24 p-2 border rounded-lg" min="5" max="60" value="60">
                        </div>
                        <div class="mb-4 text-3xl font-bold" id="turnTimerDisplay">--</div>
                        <div class="flex justify-center space-x-4">
                            <button onclick="startTurnTimer()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg">
                                <i class="fas fa-play mr-2"></i>Start Timer
                            </button>
                            <button onclick="stopTurnTimer()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-6 rounded-lg">
                                <i class="fas fa-stop mr-2"></i>Stop
                            </button>
                        </div>
                    </div>

                    <!-- Score History -->
                    <div class="domino-card p-6 mt-6">
                        <h3 class="text-lg font-bold mb-4">Score History</h3>
                        <div id="scoreHistory" class="max-h-40 overflow-y-auto space-y-2">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Players Section -->
        <div id="playersSection" class="section hidden">
            <div class="mb-6">
                <button onclick="showCreatePlayerForm()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-user-plus mr-2"></i>Add New Player
                </button>
            </div>

            <!-- Create Player Form -->
            <div id="createPlayerForm" class="domino-card p-6 mb-6 hidden">
                <h3 class="text-xl font-bold mb-4">Add New Player</h3>
                <div>
                    <label class="block text-sm font-medium mb-2">Player Name</label>
                    <input type="text" id="newPlayerName" class="w-full p-3 border rounded-lg" placeholder="Enter player name">
                </div>
                <div class="flex space-x-4 mt-6">
                    <button onclick="createPlayer()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Save Player
                    </button>
                    <button onclick="hideCreatePlayerForm()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <!-- Players List -->
            <div id="playersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Teams Section -->
        <div id="teamsSection" class="section hidden">
            <div class="mb-6">
                <button onclick="showCreateTeam()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>Create New Team
                </button>
            </div>

            <!-- Create Team Form -->
            <div id="createTeamForm" class="domino-card p-6 mb-6 hidden">
                <h3 class="text-xl font-bold mb-4">Create New Team</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Player 1 Name</label>
                        <input type="text" id="teamPlayer1Input" class="w-full p-3 border rounded-lg" placeholder="Enter player 1 name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Player 2 Name</label>
                        <input type="text" id="teamPlayer2Input" class="w-full p-3 border rounded-lg" placeholder="Enter player 2 name">
                    </div>
                </div>
                <div class="flex space-x-4 mt-6">
                    <button onclick="createTeam()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Create Team
                    </button>
                    <button onclick="hideCreateTeam()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <!-- Teams List -->
            <div id="teamsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="section hidden">
            <div class="domino-card p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                    <span>
                        <i class="fas fa-list mr-2 text-blue-500"></i>
                        Game History
                    </span>
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                        Total Games: <span id="totalGamesCount">0</span>
                    </span>
                </h3>
                <div id="gameHistoryList" class="space-y-2">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboardSection" class="section hidden">
            <!-- Last Updated Time -->
            <div class="mb-4 text-right text-sm text-gray-500 dark:text-gray-400">
                <i class="fas fa-clock mr-1"></i>
                Last updated: <span id="lastUpdatedTime"></span>
            </div>
            
            <div class="mb-6">
                <div class="flex flex-wrap gap-2">
                    <button onclick="showLeaderboard('daily')" class="leaderboard-tab bg-blue-500 text-white py-2 px-4 rounded-lg font-medium">
                        <i class="fas fa-calendar-day mr-1"></i>Daily
                    </button>
                    <button onclick="showLeaderboard('weekly')" class="leaderboard-tab bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg font-medium">
                        <i class="fas fa-calendar-week mr-1"></i>Weekly
                    </button>
                    <button onclick="showLeaderboard('monthly')" class="leaderboard-tab bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg font-medium">
                        <i class="fas fa-calendar-alt mr-1"></i>Monthly
                    </button>
                    <button onclick="showLeaderboard('alltime')" class="leaderboard-tab bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg font-medium">
                        <i class="fas fa-infinity mr-1"></i>All Time
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Team Rankings -->
                <div class="domino-card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span>
                            <i class="fas fa-users mr-2 text-blue-500"></i>
                            Team Rankings
                        </span>
                        <span id="teamPeriodInfo" class="text-xs text-gray-500 dark:text-gray-400"></span>
                    </h3>
                    <div id="teamRankings">
                        <!-- Dynamic content -->
                    </div>
                </div>

                <!-- Player Stats -->
                <div class="domino-card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span>
                            <i class="fas fa-user mr-2 text-green-500"></i>
                            Top Players
                        </span>
                        <span id="playerPeriodInfo" class="text-xs text-gray-500 dark:text-gray-400"></span>
                    </h3>
                    <div id="playerStats">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>

            <!-- New Stats Sections -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <!-- Opponent Comparison -->
                <div class="domino-card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-balance-scale mr-2 text-red-500"></i>
                        Opponent Comparison
                    </h3>
                    <div class="space-y-2">
                        <select id="comparison-select1" class="w-full p-2 border rounded-lg"></select>
                        <select id="comparison-select2" class="w-full p-2 border rounded-lg"></select>
                        <div id="comparison-period-selector" class="flex justify-center space-x-4 py-2">
                            <label><input type="radio" name="comparison-period" value="daily" checked> Today</label>
                            <label><input type="radio" name="comparison-period" value="alltime"> All Time</label>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="runOpponentComparison()" class="w-2/3 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">Compare</button>
                            <button onclick="resetOpponentComparison()" class="w-1/3 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Reset</button>
                        </div>
                    </div>
                    <div id="comparison-results" class="mt-4"></div>
                </div>

                <!-- Streaks & Slumps -->
                <div class="domino-card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-purple-500"></i>
                        Streaks & Slumps
                    </h3>
                    <div id="streaks-slumps-list" class="space-y-4"></div>
                </div>

                <!-- PETAROLL Leaders -->
                <div class="domino-card p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-fire-alt mr-2 text-orange-500"></i>
                        PETAROLL Leaders
                    </h3>
                    <div id="petaroll-leaders-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="winModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="domino-card p-8 m-4 max-w-md w-full text-center">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-2xl font-bold mb-4">Game Over!</h2>
            <div id="winMessage" class="text-lg mb-6"></div>
            <div class="flex space-x-4 justify-center">
                <button id="playAgainBtn" onclick="playAgain()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-play mr-2"></i>Play Again
                </button>
                <button onclick="closeWinModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="domino-card p-8 m-4 max-w-md w-full text-center">
            <div class="text-6xl mb-4 text-red-500">⚠️</div>
            <h2 class="text-2xl font-bold mb-4">Reset Data</h2>
            <p class="text-lg mb-6">Choose what you would like to reset.</p>
            <div class="flex flex-col space-y-4 justify-center">
                <button onclick="resetTodayData()" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-calendar-day mr-2"></i>Reset Today's Data
                </button>
                <button onclick="resetAllData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-trash-alt mr-2"></i>Reset Everything
                </button>
                <button onclick="closeResetModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium mt-4">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="domino-card p-8 m-4 max-w-md w-full text-center">
            <div id="confirmModalIcon" class="text-6xl mb-4 text-red-500">⚠️</div>
            <h2 id="confirmModalTitle" class="text-2xl font-bold mb-4">Are you sure?</h2>
            <p id="confirmModalMessage" class="text-lg mb-6">This action cannot be undone.</p>
            <div class="flex space-x-4 justify-center">
                <button id="confirmModalConfirmBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-medium">
                    Confirm
                </button>
                <button onclick="closeConfirmModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Generic Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg">
        <p id="toastMessage"></p>
    </div>


    <!-- Export Modal -->
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="domino-card p-8 m-4 max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">Export Data</h2>
            <p class="text-center mb-6">Choose a format to download your data.</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="exportDataAs('pdf')" class="bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fas fa-file-pdf mr-2"></i>Export as PDF
                </button>
                <button onclick="exportDataAs('csv')" class="bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fas fa-file-csv mr-2"></i>Export as CSV
                </button>
                <button onclick="exportDataAs('txt')" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fas fa-file-alt mr-2"></i>Export as TXT
                </button>
                <button onclick="exportData()" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center">
                    <i class="fas fa-file-code mr-2"></i>Export as JSON
                </button>
            </div>
            <div class="text-center mt-6">
                <button onclick="closeExportModal()" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-6 rounded-lg font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Game Modal -->
    <div id="editGameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="domino-card p-8 m-4 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4">Edit Game</h2>
            <div id="editGameForm">
                <!-- Dynamic content -->
            </div>
            <div class="flex space-x-4 mt-6">
                <button onclick="saveGameEdits()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
                <button onclick="closeEditGameModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="achievementToast" class="hidden"></div>

    <script>
        // Global variables
        let currentGame = null;
        let currentGameMode = null;
        let players = JSON.parse(localStorage.getItem('dominoPlayers')) || [];
        let teams = JSON.parse(localStorage.getItem('dominoTeams')) || [];
        let games = JSON.parse(localStorage.getItem('dominoGames')) || [];
        let currentSection = 'home';
        let chartInstances = {};
        let currentPeriod = 'daily';
        let bestOf = 1;
        let matchWins1 = 0;
        let matchWins2 = 0;
        let matchOver = false;
        let turnTimer = null;
        let remainingTime = 0;
        let editingGameId = null;
        
        let achievements = JSON.parse(localStorage.getItem('dominoAchievements')) || {};
        let streaks = JSON.parse(localStorage.getItem('dominoStreaks')) || {};
        const achievementDefinitions = {
            tenWins: { text: 'Ten Wins Club', icon: '🏅', description: 'Win 10 games' },
            anyPetaroll: { text: 'First PETAROLL', icon: '🔥', description: 'Achieve your first PETAROLL' },
            comebackKing: { text: 'Comeback King', icon: '👑', description: 'Win after being down by 50+ points' },
            dominator: { text: 'Dominator', icon: '🏆', description: 'Win 5 games in a row' }
        };
        
        let pendingWinType = null;
        let recognition;
        let isMicOn = false;

        // Sound Effects using Web Audio API
        let audioCtx;
        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
            }
        }

        function playSound(type) {
            if (!audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);


            switch(type) {
                case 'addScore':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(660, audioCtx.currentTime); // E5
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
                    break;
                case 'win':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.4); // C6
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
                    break;
                case 'petaroll':
                     oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime); // G5
                    oscillator.frequency.linearRampToValueAtTime(1046.50, audioCtx.currentTime + 0.2); // C6
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.6);
                    break;
            }

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 1);
        }


        // Theme management
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeIcon').className = 'fas fa-moon';
            }
            refreshAllData();
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
            refreshAllData();
        });

        // Export functionality
        function showExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function exportData() {
            const data = {
                players: players,
                teams: teams,
                games: games,
                achievements: achievements,
                streaks: streaks,
                exportDate: new Date().toISOString(),
                version: '1.2'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `domino-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            closeExportModal();
        }

        function exportDataAs(format) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let dataString = '';
            let fileExtension = '';

            const header = `Domino Tracker Data Export - ${new Date().toLocaleString()}\n\n`;

            // Players Data
            dataString += 'Players\n';
            dataString += 'ID,Name\n';
            players.forEach(p => {
                dataString += `${p.id},${p.name}\n`;
            });

            // Teams Data
            dataString += '\nTeams\n';
            dataString += 'ID,Player 1,Player 2\n';
            teams.forEach(t => {
                dataString += `${t.id},${t.player1},${t.player2}\n`;
            });

            // Games Data
            dataString += '\nGames\n';
            dataString += 'ID,Date,Mode,Winner,Loser,Winner Score,Loser Score,Petaroll\n';
            games.forEach(g => {
                const winnerName = g.gameMode === 'team' ? teams.find(t => t.id === g.winner)?.player1 + ' & ' + teams.find(t => t.id === g.winner)?.player2 : g.winner;
                const loserName = g.gameMode === 'team' ? teams.find(t => t.id === g.loser)?.player1 + ' & ' + teams.find(t => t.id === g.loser)?.player2 : g.loser;
                dataString += `${g.id},${new Date(g.date).toLocaleString()},${g.gameMode},"${winnerName}","${loserName}",${g.winnerScore},${g.loserScore},${g.isPetaroll ? 'Yes' : 'No'}\n`;
            });

            if (format === 'pdf') {
                doc.text(header, 10, 10);
                doc.text(dataString, 10, 20);
                doc.save('domino-tracker-data.pdf');
            } else {
                if (format === 'csv') {
                    fileExtension = 'csv';
                } else {
                    fileExtension = 'txt';
                }
                const blob = new Blob([header + dataString], { type: `text/${fileExtension};charset=utf-8;` });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `domino-tracker-data.${fileExtension}`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            closeExportModal();
        }


        // Reset functionality
        function showResetModal() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
        }
        
        function resetTodayData() {
            showConfirmModal(
                'Reset Today\'s Data',
                'Are you sure you want to delete all games from today? This action cannot be undone.',
                () => {
                    const today = new Date().toDateString();
                    games = games.filter(g => new Date(g.date).toDateString() !== today);
                    localStorage.setItem('dominoGames', JSON.stringify(games));

                    // Filter out achievements earned today
                    for (const entityId in achievements) {
                        achievements[entityId] = achievements[entityId].filter(ach => {
                            return new Date(ach.date).toDateString() !== today;
                        });
                    }
                    localStorage.setItem('dominoAchievements', JSON.stringify(achievements));
                    
                    closeResetModal();
                    refreshAllData();
                    showToast("Today's games and achievements have been reset.");
                }
            );
        }


        function resetAllData() {
            showConfirmModal(
                'Reset Everything',
                'Are you absolutely sure you want to delete all data? This action cannot be undone.',
                () => {
                    localStorage.removeItem('dominoPlayers');
                    localStorage.removeItem('dominoTeams');
                    localStorage.removeItem('dominoGames');
                    localStorage.removeItem('dominoAchievements');
                    localStorage.removeItem('dominoStreaks');
                    
                    players = [];
                    teams = [];
                    games = [];
                    achievements = {};
                    streaks = {};
                    currentGame = null;
                    
                    Object.values(chartInstances).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    chartInstances = {};
                    
                    closeResetModal();
                    refreshAllData();
                    showToast('All data has been reset successfully!');
                }
            );
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
            currentSection = section;
            
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll(`[data-section="${section}"]`).forEach(btn => {
                btn.classList.add('active');
            });
            
            if (section === 'home') loadHome();
            else if (section === 'players') loadPlayers();
            else if (section === 'teams') loadTeams();
            else if (section === 'leaderboard') loadLeaderboard();
            else if (section === 'live') loadLiveSection();
            else if (section === 'history') loadHistory();
        }

        function refreshAllData() {
            loadTodaysPerformance();
            loadRecentGames();
            loadDailyPlayerSummary();
            
            if (currentSection === 'history') {
                loadHistory();
            }
            if (currentSection === 'teams') {
                loadTeams();
            }
             if (currentSection === 'players') {
                loadPlayers();
            }
            if (currentSection === 'leaderboard') {
                loadLeaderboard();
            }
            if (currentSection === 'home') {
                loadAchievements();
            }
        }
        
        // Home section
        function loadHome() {
            loadTodaysPerformance();
            loadRecentGames();
            loadDailyPlayerSummary();
            loadAchievements();
        }

        function loadTodaysPerformance() {
            const today = new Date().toDateString();
            const todayGames = games.filter(g => new Date(g.date).toDateString() === today);

            const teamGames = todayGames.filter(g => g.gameMode === 'team');
            const singleGames = todayGames.filter(g => g.gameMode === 'single');

            let html = '';

            // Team Game Stats
            if (teamGames.length > 0) {
                const teamStats = {};
                teams.forEach(team => {
                    const teamName = `${team.player1} & ${team.player2}`;
                    teamStats[team.id] = { name: teamName, wins: 0, losses: 0, petarolls: 0, gotPetarolled: 0 };
                });

                teamGames.forEach(game => {
                    if (teamStats[game.winner]) {
                        teamStats[game.winner].wins += game.gameValue || 1;
                        if (game.isPetaroll) teamStats[game.winner].petarolls++;
                    }
                    if (teamStats[game.loser]) {
                        teamStats[game.loser].losses += game.gameValue || 1;
                        if (game.isPetaroll) teamStats[game.loser].gotPetarolled++;
                    }
                });

                const filteredTeamStats = Object.values(teamStats).filter(stat => stat.wins > 0 || stat.losses > 0);

                if (filteredTeamStats.length > 0) {
                    html += '<h4 class="font-bold mb-2 text-gray-700 dark:text-gray-300">Team Games</h4>';
                    html += filteredTeamStats.map(stat => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg mb-2">
                            <span class="font-medium">${stat.name}</span>
                            <div class="flex items-center space-x-4">
                                <span class="text-green-600 font-bold">+${stat.wins}</span>
                                <span class="text-red-600 font-bold">-${stat.losses}</span>
                                ${stat.petarolls > 0 ? `<span class="petaroll-badge">${stat.petarolls} PETAROLL</span>` : ''}
                                ${stat.gotPetarolled > 0 ? `<span class="petarolled-badge">${stat.gotPetarolled} PETAROLLED</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }

            // Single Game Stats
            if (singleGames.length > 0) {
                const singlePlayerStats = {};
                singleGames.forEach(game => {
                    if (!singlePlayerStats[game.winner]) singlePlayerStats[game.winner] = { name: game.winner, wins: 0, losses: 0, petarolls: 0, gotPetarolled: 0 };
                    if (!singlePlayerStats[game.loser]) singlePlayerStats[game.loser] = { name: game.loser, wins: 0, losses: 0, petarolls: 0, gotPetarolled: 0 };

                    singlePlayerStats[game.winner].wins += game.gameValue || 1;
                    if (game.isPetaroll) singlePlayerStats[game.winner].petarolls++;
                    
                    singlePlayerStats[game.loser].losses += game.gameValue || 1;
                    if (game.isPetaroll) singlePlayerStats[game.loser].gotPetarolled++;
                });

                const filteredSingleStats = Object.values(singlePlayerStats).filter(stat => stat.wins > 0 || stat.losses > 0);

                if (filteredSingleStats.length > 0) {
                    html += '<h4 class="font-bold mt-4 mb-2 text-gray-700 dark:text-gray-300">One-on-One Games</h4>';
                    html += filteredSingleStats.map(stat => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg mb-2">
                            <span class="font-medium">${stat.name}</span>
                            <div class="flex items-center space-x-4">
                                <span class="text-green-600 font-bold">+${stat.wins}</span>
                                <span class="text-red-600 font-bold">-${stat.losses}</span>
                                ${stat.petarolls > 0 ? `<span class="petaroll-badge">${stat.petarolls} PETAROLL</span>` : ''}
                                ${stat.gotPetarolled > 0 ? `<span class="petarolled-badge">${stat.gotPetarolled} PETAROLLED</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }

            document.getElementById('todaysPerformance').innerHTML = html || '<p class="text-gray-500 dark:text-gray-400">No games played today</p>';
        }

        function loadRecentGames() {
            const recentGames = games.slice(-5).reverse();
            const recentHtml = recentGames.map(game => {
                let winnerName, loserName;
                
                if (game.gameMode === 'single') {
                    winnerName = game.winner;
                    loserName = game.loser;
                } else {
                    const winnerTeam = teams.find(t => t.id === game.winner);
                    const loserTeam = teams.find(t => t.id === game.loser);
                    winnerName = winnerTeam ? `${winnerTeam.player1} & ${winnerTeam.player2}` : 'Unknown';
                    loserName = loserTeam ? `${loserTeam.player1} & ${loserTeam.player2}` : 'Unknown';
                }
                
                const gameTypeIcon = game.gameMode === 'single' ? '<i class="fas fa-user text-xs mr-1"></i>' : '<i class="fas fa-users text-xs mr-1"></i>';
                
                if (game.isPetaroll) {
                    return `
                        <div class="text-sm p-2 bg-gray-50 dark:bg-gray-700 rounded game-item relative">
                            <div>
                                ${gameTypeIcon}<strong>${winnerName}</strong> PETAROLLED <strong>${loserName}</strong>
                                <span class="petaroll-badge">PETAROLL</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 text-xs">
                                ${game.winnerScore}-${game.loserScore} • ${new Date(game.date).toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="text-sm p-2 bg-gray-50 dark:bg-gray-700 rounded game-item relative">
                            <div>
                                ${gameTypeIcon}<strong>${winnerName}</strong> beat <strong>${loserName}</strong>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400 text-xs">
                                ${game.winnerScore}-${game.loserScore} • ${new Date(game.date).toLocaleString()}
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('recentGames').innerHTML = recentHtml || '<p class="text-gray-500 dark:text-gray-400 text-sm">No recent games</p>';
        }

        function getShortName(entityName) {
            if (entityName.includes(' & ')) {
                const names = entityName.split(' & ');
                return names.map(name => name.charAt(0)).join(' & ');
            }
            return entityName;
        }

        function loadAchievements() {
            const listEl = document.getElementById('achievementsList');
            let html = '';
            
            const allEntities = [
                ...players.map(p => ({ id: `player:${p.name}`, name: p.name })),
                ...teams.map(t => ({ id: `team:${t.id}`, name: `${t.player1} & ${t.player2}` }))
            ];
            
            const allUnlockedAchievements = {};
            for (const entityId in achievements) {
                if (achievements.hasOwnProperty(entityId)) {
                    achievements[entityId].forEach(ach => {
                        if (!allUnlockedAchievements[ach.key]) {
                            allUnlockedAchievements[ach.key] = [];
                        }
                        allUnlockedAchievements[ach.key].push(getShortName(getEntityName(entityId)));
                    });
                }
            }

            for (const key in achievementDefinitions) {
                const definition = achievementDefinitions[key];
                const unlockedBy = allUnlockedAchievements[key];

                if (unlockedBy) {
                    html += `<button class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg font-medium flex items-center" title="${definition.description} - Unlocked by: ${unlockedBy.join(', ')}">
                                <span class="w-8 text-center">${definition.icon}</span>
                                <span>${definition.text} - ${unlockedBy.join(', ')}</span>
                             </button>`;
                } else {
                    html += `
                        <button class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg font-medium opacity-70 cursor-not-allowed flex items-center" title="${definition.description} (Locked)">
                            <span class="w-8 text-center"><i class="fas fa-lock"></i></span>
                            <span>${definition.icon} ${definition.text}</span>
                        </button>
                    `;
                }
            }

            listEl.innerHTML = html || '<p class="text-gray-500 dark:text-gray-400">No achievements defined.</p>';
        }


        function getEntityName(entityId) {
            if (!entityId) return 'Unknown';
            const [type, id] = entityId.split(':');
            if (type === 'player') {
                return id;
            } else if (type === 'team') {
                const team = teams.find(t => t.id === id);
                return team ? `${team.player1} & ${team.player2}` : 'Unknown Team';
            }
            return 'Unknown';
        }

        function grantAchievement(entityId, achievementKey) {
            if (!entityId || !achievementKey) return;

            achievements[entityId] = achievements[entityId] || [];
            
            if (achievements[entityId].some(ach => typeof ach === 'string')) {
                achievements[entityId] = achievements[entityId].map(ach => {
                    if (typeof ach === 'string') {
                        return { key: ach, date: new Date(0).toISOString() }; 
                    }
                    return ach;
                });
            }

            const alreadyUnlocked = achievements[entityId].some(ach => ach.key === achievementKey);

            if (!alreadyUnlocked) {
                achievements[entityId].push({ key: achievementKey, date: new Date().toISOString() });
                localStorage.setItem('dominoAchievements', JSON.stringify(achievements));
                const entityName = getEntityName(entityId);
                showAchievement(`Achievement Unlocked for ${entityName}: ${achievementDefinitions[achievementKey].text}`);
                loadAchievements();
            }
        }
        
        function checkAllAchievements(gameRecord) {
            const winnerId = gameRecord.gameMode === 'team' ? `team:${gameRecord.winner}` : `player:${gameRecord.winner}`;
            const loserId = gameRecord.gameMode === 'team' ? `team:${gameRecord.loser}` : `player:${gameRecord.loser}`;

            if (gameRecord.isPetaroll) {
                grantAchievement(winnerId, 'anyPetaroll');
            }

            const winnerTotalWins = games.filter(g => {
                if (g.gameMode === 'team' && winnerId.startsWith('team')) return g.winner === winnerId.split(':')[1];
                if (g.gameMode === 'single' && winnerId.startsWith('player')) return g.winner === winnerId.split(':')[1];
                return false;
            }).reduce((sum, g) => sum + (g.gameValue || 1), 0);
            if(winnerTotalWins >= 10) {
                grantAchievement(winnerId, 'tenWins');
            }

            if(gameRecord.wasComeback) {
                grantAchievement(winnerId, 'comebackKing');
            }

            streaks[winnerId] = (streaks[winnerId] || 0) + 1;
            streaks[loserId] = 0; // Reset loser's streak
            localStorage.setItem('dominoStreaks', JSON.stringify(streaks));
            
            if (streaks[winnerId] >= 5) {
                grantAchievement(winnerId, 'dominator');
            }
        }

        function showAchievement(message) {
            const toast = document.getElementById('achievementToast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function loadHistory() {
            document.getElementById('totalGamesCount').textContent = games.length;
            
            const sortedGames = [...games].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const historyHtml = sortedGames.map(game => {
                let winnerName, loserName;
                
                if (game.gameMode === 'single') {
                    winnerName = game.winner;
                    loserName = game.loser;
                } else {
                    const winnerTeam = teams.find(t => t.id === game.winner);
                    const loserTeam = teams.find(t => t.id === game.loser);
                    winnerName = winnerTeam ? `${winnerTeam.player1} & ${winnerTeam.player2}` : 'Unknown';
                    loserName = loserTeam ? `${loserTeam.player1} & ${loserTeam.player2}` : 'Unknown';
                }
                
                const duration = game.duration ? formatDuration(game.duration) : 'N/A';
                const gameTypeIcon = game.gameMode === 'single' ? '<i class="fas fa-user text-sm mr-1"></i>' : '<i class="fas fa-users text-sm mr-1"></i>';
                
                return `
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg game-item relative">
                        <button onclick="showEditGameModal('${game.id}')" class="edit-game-btn absolute top-2 right-10 text-blue-500 hover:text-blue-700 p-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteGame('${game.id}')" class="delete-game-btn absolute top-2 right-2 text-red-500 hover:text-red-700 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium">
                                    ${gameTypeIcon}${winnerName} ${game.isPetaroll ? 'PETAROLLED' : 'beat'} ${loserName}
                                    ${game.isPetaroll ? `<span class="petaroll-badge">PETAROLL</span>` : ''}
                                    ${game.wasComeback ? `<span class="achievement-badge">👑</span>` : ''}
                                </div>
                                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                    Score: ${game.winnerScore} - ${game.loserScore} | Duration: ${duration}
                                </div>
                                <div class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                    ${new Date(game.date).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('gameHistoryList').innerHTML = historyHtml || '<p class="text-gray-500 dark:text-gray-400">No games played yet</p>';
        }

        function formatDuration(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function deleteGame(gameId) {
            showConfirmModal(
                'Delete Game',
                'Are you sure you want to delete this game? This will affect all statistics.',
                () => {
                    games = games.filter(g => g.id != gameId);
                    localStorage.setItem('dominoGames', JSON.stringify(games));
                    refreshAllData();
                    showToast('Game deleted successfully!');
                }
            );
        }

        function showEditGameModal(gameId) {
            const game = games.find(g => g.id == gameId);
            if (!game) return;
            editingGameId = gameId;

            let formHtml = '';
            if (game.gameMode === 'team') {
                const options = teams.map(t => `<option value="${t.id}">${t.player1} & ${t.player2}</option>`).join('');
                formHtml += `
                    <label class="block text-sm font-medium">Winner</label>
                    <select id="editWinner" class="w-full p-2 border rounded-lg mb-2">${options}</select>
                    <label class="block text-sm font-medium">Loser</label>
                    <select id="editLoser" class="w-full p-2 border rounded-lg mb-2">${options}</select>
                `;
            } else {
                const options = players.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
                 formHtml += `
                    <label class="block text-sm font-medium">Winner</label>
                    <select id="editWinner" class="w-full p-2 border rounded-lg mb-2">${options}</select>
                    <label class="block text-sm font-medium">Loser</label>
                    <select id="editLoser" class="w-full p-2 border rounded-lg mb-2">${options}</select>
                `;
            }

            formHtml += `
                <label class="block text-sm font-medium">Winner Score</label>
                <input id="editWinnerScore" type="number" class="w-full p-2 border rounded-lg mb-2" />
                <label class="block text-sm font-medium">Loser Score</label>
                <input id="editLoserScore" type="number" class="w-full p-2 border rounded-lg mb-2" />
                <label class="inline-flex items-center mt-2"><input type="checkbox" id="editIsPetaroll" class="mr-2">PETAROLL</label>
            `;

            document.getElementById('editGameForm').innerHTML = formHtml;

            document.getElementById('editWinner').value = game.winner;
            document.getElementById('editLoser').value = game.loser;
            document.getElementById('editWinnerScore').value = game.winnerScore;
            document.getElementById('editLoserScore').value = game.loserScore;
            document.getElementById('editIsPetaroll').checked = !!game.isPetaroll;

            document.getElementById('editGameModal').classList.remove('hidden');
        }

        function closeEditGameModal() {
            document.getElementById('editGameModal').classList.add('hidden');
            editingGameId = null;
        }

        function saveGameEdits() {
            if (editingGameId === null) return;
            const gameIndex = games.findIndex(g => g.id == editingGameId);
            if (gameIndex === -1) return;

            const game = games[gameIndex];
            const winnerVal = document.getElementById('editWinner').value;
            const loserVal = document.getElementById('editLoser').value;
            
            game.winner = winnerVal;
            game.loser = loserVal;
            game.winnerScore = parseInt(document.getElementById('editWinnerScore').value) || 0;
            game.loserScore = parseInt(document.getElementById('editLoserScore').value) || 0;
            game.isPetaroll = document.getElementById('editIsPetaroll').checked;
            game.gameValue = game.isPetaroll ? 2 : 1;

            localStorage.setItem('dominoGames', JSON.stringify(games));
            closeEditGameModal();
            refreshAllData();
        }

        function loadDailyPlayerSummary() {
            const today = new Date().toDateString();
            const todayGames = games.filter(g => new Date(g.date).toDateString() === today);
            const summaryContainer = document.getElementById('dailyPlayerSummaryList');

            if (todayGames.length === 0) {
                summaryContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No games played today to summarize.</p>';
                return;
            }

            const playerSummaries = {};

            // Helper to initialize a player summary
            const initPlayer = (name) => {
                if (!playerSummaries[name]) {
                    playerSummaries[name] = { wins: 0, losses: 0, games: [] };
                }
            };

            todayGames.forEach(game => {
                if (game.gameMode === 'single') {
                    const winnerName = game.winner;
                    const loserName = game.loser;

                    initPlayer(winnerName);
                    initPlayer(loserName);

                    // Add win for winner
                    playerSummaries[winnerName].wins += game.gameValue || 1;
                    playerSummaries[winnerName].games.push(
                        `<li class="text-sm"><span class="font-bold text-green-600">Win</span> vs ${loserName} (${game.winnerScore}-${game.loserScore}) ${game.isPetaroll ? '<span class="petaroll-badge !ml-1">PETAROLL</span>' : ''}</li>`
                    );

                    // Add loss for loser
                    playerSummaries[loserName].losses += game.gameValue || 1;
                    playerSummaries[loserName].games.push(
                        `<li class="text-sm"><span class="font-bold text-red-600">Loss</span> vs ${winnerName} (${game.loserScore}-${game.winnerScore}) ${game.isPetaroll ? '<span class="petarolled-badge !ml-1">PETAROLLED</span>' : ''}</li>`
                    );

                } else { // Team game
                    const winnerTeam = teams.find(t => t.id === game.winner);
                    const loserTeam = teams.find(t => t.id === game.loser);

                    if (!winnerTeam || !loserTeam) return; // Skip if team not found

                    const winnerNames = [winnerTeam.player1, winnerTeam.player2];
                    const loserNames = [loserTeam.player1, loserTeam.player2];

                    winnerNames.forEach(initPlayer);
                    loserNames.forEach(initPlayer);

                    // Add wins for winners
                    winnerNames.forEach(name => {
                        playerSummaries[name].wins += game.gameValue || 1;
                        const partner = winnerNames.find(p => p !== name);
                        playerSummaries[name].games.push(
                            `<li class="text-sm"><span class="font-bold text-green-600">Win</span> with ${partner} vs ${loserNames.join(' & ')} (${game.winnerScore}-${game.loserScore}) ${game.isPetaroll ? '<span class="petaroll-badge !ml-1">PETAROLL</span>' : ''}</li>`
                        );
                    });

                    // Add losses for losers
                    loserNames.forEach(name => {
                        playerSummaries[name].losses += game.gameValue || 1;
                        const partner = loserNames.find(p => p !== name);
                        playerSummaries[name].games.push(
                            `<li class="text-sm"><span class="font-bold text-red-600">Loss</span> with ${partner} vs ${winnerNames.join(' & ')} (${game.loserScore}-${game.winnerScore}) ${game.isPetaroll ? '<span class="petarolled-badge !ml-1">PETAROLLED</span>' : ''}</li>`
                        );
                    });
                }
            });

            let summaryHtml = '';
            Object.keys(playerSummaries).sort().forEach(playerName => {
                const summary = playerSummaries[playerName];
                summaryHtml += `
                    <div>
                        <h5 class="font-bold">${playerName} <span class="font-normal text-gray-600 dark:text-gray-400">(${summary.wins}W - ${summary.losses}L)</span></h5>
                        <ul class="list-disc list-inside pl-2 mt-1 space-y-1">
                            ${summary.games.join('')}
                        </ul>
                    </div>
                `;
            });
            
            summaryContainer.innerHTML = summaryHtml;
        }

        // Live game section
        function loadLiveSection() {
            document.getElementById('gameSetup').classList.add('hidden');
            document.getElementById('liveGame').classList.add('hidden');
            document.getElementById('teamModeBtn').classList.remove('active');
            document.getElementById('singleModeBtn').classList.remove('active');
            currentGameMode = null;
        }

        function selectGameMode(mode) {
            currentGameMode = mode;
            
            document.getElementById('teamModeBtn').classList.toggle('active', mode === 'team');
            document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
            
            document.getElementById('teamModeSetup').classList.toggle('hidden', mode !== 'team');
            document.getElementById('singleModeSetup').classList.toggle('hidden', mode !== 'single');
            
            populateSelectionDropdowns(); 
            
            document.getElementById('gameSetup').classList.remove('hidden');
        }

        function populateSelectionDropdowns() {
            const playerOptions = ['<option value="">Select player</option>'];
            players.forEach(player => {
                playerOptions.push(`<option value="${player.name}">${player.name}</option>`);
            });
            const playerOptionsHtml = playerOptions.join('');

            if (currentGameMode === 'team') {
                // Team mode dropdowns should show both players and teams
                const teamOptions = ['<option value="">Select team or player</option>'];
                
                // Add individual players
                players.forEach(player => {
                    teamOptions.push(`<option value="player:${player.name}">${player.name}</option>`);
                });
                
                // Add teams
                teams.forEach(team => {
                    teamOptions.push(`<option value="team:${team.id}">${team.player1} & ${team.player2}</option>`);
                });
                
                const optionsHtml = teamOptions.join('');
                document.getElementById('gameTeam1Selection').innerHTML = optionsHtml;
                document.getElementById('gameTeam2Selection').innerHTML = optionsHtml;

                // Populate the new player select dropdowns
                document.getElementById('gameTeam1Player1Input').innerHTML = playerOptionsHtml;
                document.getElementById('gameTeam1Player2Input').innerHTML = playerOptionsHtml;
                document.getElementById('gameTeam2Player1Input').innerHTML = playerOptionsHtml;
                document.getElementById('gameTeam2Player2Input').innerHTML = playerOptionsHtml;
                
            } else if (currentGameMode === 'single') {
                // Single mode dropdowns show only players
                document.getElementById('player1Select').innerHTML = playerOptionsHtml;
                document.getElementById('player2Select').innerHTML = playerOptionsHtml;
            }
        }

        function handleTeamSelection(teamPosition, value) {
            if (!value) return;
            
            const player1Input = document.getElementById(`game${teamPosition.charAt(0).toUpperCase() + teamPosition.slice(1)}Player1Input`);
            const player2Input = document.getElementById(`game${teamPosition.charAt(0).toUpperCase() + teamPosition.slice(1)}Player2Input`);
            
            if (value.startsWith('team:')) {
                // Selected a team - auto-populate players
                const teamId = value.split(':')[1];
                const selectedTeam = teams.find(t => t.id === teamId);
                if (selectedTeam) {
                    player1Input.value = selectedTeam.player1;
                    player2Input.value = selectedTeam.player2;
                }
            } else if (value.startsWith('player:')) {
                // Selected an individual player - put in player 1 field
                const playerName = value.split(':')[1];
                player1Input.value = playerName;
                player2Input.value = '';
            }
        }

        function startNewGame() {
            showSection('live');
        }

        function startGame() {
            bestOf = parseInt(document.getElementById('bestOfSelect').value);
            matchWins1 = 0;
            matchWins2 = 0;
            matchOver = false;

            if (currentGameMode === 'team') {
                const t1p1 = document.getElementById('gameTeam1Player1Input').value.trim();
                const t1p2 = document.getElementById('gameTeam1Player2Input').value.trim();
                const t2p1 = document.getElementById('gameTeam2Player1Input').value.trim();
                const t2p2 = document.getElementById('gameTeam2Player2Input').value.trim();

                const allPlayerNames = [t1p1, t1p2, t2p1, t2p2];
                if (allPlayerNames.some(name => name === '')) {
                    showToast('Please enter all four player names.');
                    return;
                }

                const uniqueNames = new Set(allPlayerNames.map(n => n.toLowerCase()));
                if (uniqueNames.size !== 4) {
                    showToast('Please enter four unique player names for the game.');
                    return;
                }

                allPlayerNames.forEach(addPlayerIfNotExists);

                const team1 = findOrCreateTeam(t1p1, t1p2);
                const team2 = findOrCreateTeam(t2p1, t2p2);
                
                currentGame = {
                    gameMode: 'team',
                    team1: team1,
                    team2: team2,
                    score1: 0,
                    score2: 0,
                    history: [],
                    startTime: new Date(),
                    ended: false
                };
                
                document.getElementById('team1Players').textContent = `${team1.player1} & ${team1.player2}`;
                document.getElementById('team2Players').textContent = `${team2.player1} & ${team2.player2}`;

            } else { // Single mode
                const player1Name = document.getElementById('player1Select').value.trim();
                const player2Name = document.getElementById('player2Select').value.trim();
                
                if (!player1Name || !player2Name) {
                    showToast('Please select both players');
                    return;
                }
                 if (player1Name.toLowerCase() === player2Name.toLowerCase()) {
                    showToast('Players must be different.');
                    return;
                }

                addPlayerIfNotExists(player1Name);
                addPlayerIfNotExists(player2Name);
                
                currentGame = {
                    gameMode: 'single',
                    player1: player1Name,
                    player2: player2Name,
                    score1: 0,
                    score2: 0,
                    history: [],
                    startTime: new Date(),
                    ended: false
                };
                
                document.getElementById('team1Players').textContent = player1Name;
                document.getElementById('team2Players').textContent = player2Name;
            }
            
            document.getElementById('gameSetup').classList.add('hidden');
            document.getElementById('liveGame').classList.remove('hidden');
            
            document.getElementById('customScore1').value = '';
            document.getElementById('customScore2').value = '';
            
            enableScoreButtons();
            updateGameDisplay();
            updateMatchScoreDisplay();
        }

        function updateGameDisplay() {
            if (!currentGame) return;
            
            document.getElementById('team1Score').textContent = currentGame.score1;
            document.getElementById('team2Score').textContent = currentGame.score2;
            
            const progress1 = Math.min((currentGame.score1 / 150) * 100, 100);
            const progress2 = Math.min((currentGame.score2 / 150) * 100, 100);
            document.getElementById('team1Progress').style.width = progress1 + '%';
            document.getElementById('team2Progress').style.width = progress2 + '%';
            
            const petarollAlert = document.getElementById('petarollAlert');
            if ((currentGame.score1 >= 50 && currentGame.score2 === 0) || 
                (currentGame.score2 >= 50 && currentGame.score1 === 0)) {
                petarollAlert.classList.remove('hidden');
                petarollAlert.classList.add('petaroll-alert');
                
                if (currentGame.score1 >= 50 && currentGame.score2 === 0) {
                    document.getElementById('team1Score').classList.add('text-orange-600');
                } else {
                    document.getElementById('team2Score').classList.add('text-orange-600');
                }
            } else {
                petarollAlert.classList.add('hidden');
                document.getElementById('team1Score').classList.remove('text-orange-600');
                document.getElementById('team2Score').classList.remove('text-orange-600');
            }
            
            const historyHtml = currentGame.history.map((entry, index) => {
                const pointsDisplay = entry.points > 0 ? `+${entry.points}` : `${entry.points}`;
                const colorClass = entry.points > 0 ? 'text-green-600' : 'text-red-600';
                
                return `
                    <div class="text-sm p-2 bg-gray-50 dark:bg-gray-700 rounded flex justify-between">
                        <span>${entry.team} <span class="${colorClass} font-bold">${pointsDisplay}</span></span>
                        <span class="text-gray-500 dark:text-gray-400">${entry.team1Score} - ${entry.team2Score}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('scoreHistory').innerHTML = historyHtml;
        }

        function updateMatchScoreDisplay() {
            const display = document.getElementById('matchScore');
            if (display) {
                display.textContent = `Match Score: ${matchWins1} - ${matchWins2}`;
            }
        }

        function addCustomScore(team) {
            const customScoreInput = document.getElementById(`customScore${team}`);
            const customScore = parseInt(customScoreInput.value);
            
            if (isNaN(customScore) || customScore === 0) {
                showToast('Please enter a valid score');
                return;
            }
            
            if (customScore < 0) {
                const currentScore = team === 1 ? currentGame.score1 : currentGame.score2;
                if (currentScore + customScore < 0) {
                    showToast('Score cannot go below 0');
                    return;
                }
            }
            
            addScore(team, customScore);
            customScoreInput.value = '';
        }

        function subtractCustomScore(team) {
            const customScoreInput = document.getElementById(`customScore${team}`);
            let customScore = parseInt(customScoreInput.value);
            
            if (isNaN(customScore) || customScore === 0) {
                customScore = 5;
            }
            
            customScore = Math.abs(customScore);
            
            const currentScore = team === 1 ? currentGame.score1 : currentGame.score2;
            if (currentScore - customScore < 0) {
                showToast('Score cannot go below 0');
                return;
            }
            
            addScore(team, -customScore);
            customScoreInput.value = '';
        }

        function addScore(team, points) {
            if (!currentGame || currentGame.ended) return;
            
            if (team === 1) {
                currentGame.score1 = Math.max(0, currentGame.score1 + points);
            } else {
                currentGame.score2 = Math.max(0, currentGame.score2 + points);
            }
            
            let teamName;
            if (currentGame.gameMode === 'team') {
                teamName = team === 1 
                    ? `${currentGame.team1.player1} & ${currentGame.team1.player2}`
                    : `${currentGame.team2.player1} & ${currentGame.team2.player2}`;
            } else {
                teamName = team === 1 ? currentGame.player1 : currentGame.player2;
            }
            
            currentGame.history.push({
                team: teamName,
                points: points,
                team1Score: currentGame.score1,
                team2Score: currentGame.score2,
            });
            
            playSound('addScore');
            updateGameDisplay();
            
            const score1 = currentGame.score1;
            const score2 = currentGame.score2;
            
            if ((score1 >= 75 && score2 === 0) || (score2 >= 75 && score1 === 0)) {
                pendingWinType = 'petaroll';
                showConfirmScoreUI();
                return;
            }
            
            if (score1 >= 150 || score2 >= 150) {
                pendingWinType = ((score1 >= 150 && score2 < 75) || (score2 >= 150 && score1 < 75)) ? 'petaroll' : 'regular';
                showConfirmScoreUI();
            }
        }

        function showConfirmScoreUI() {
            disableScoreButtons();
            document.getElementById('gameControls').classList.add('hidden');
            document.getElementById('confirmScoreContainer').classList.remove('hidden');
            document.getElementById('confirmScoreBtn').onclick = confirmFinalScore;
            document.getElementById('correctScoreBtn').onclick = correctScore;
        }

        function confirmFinalScore() {
            if (pendingWinType === 'petaroll') {
                declarePetaroll();
            } else {
                declareWinner();
            }
            pendingWinType = null;
            document.getElementById('confirmScoreContainer').classList.add('hidden');
            document.getElementById('gameControls').classList.remove('hidden');
        }

        function correctScore() {
            enableScoreButtons();
            pendingWinType = null;
            document.getElementById('confirmScoreContainer').classList.add('hidden');
            document.getElementById('gameControls').classList.remove('hidden');
        }

        function undoScore(team) {
            if (!currentGame || currentGame.history.length === 0) return;
            
            let teamName;
            if (currentGame.gameMode === 'team') {
                teamName = team === 1 
                    ? `${currentGame.team1.player1} & ${currentGame.team1.player2}`
                    : `${currentGame.team2.player1} & ${currentGame.team2.player2}`;
            } else {
                teamName = team === 1 ? currentGame.player1 : currentGame.player2;
            }
            
            let lastTeamEntryIndex = -1;
            for (let i = currentGame.history.length - 1; i >= 0; i--) {
                if (currentGame.history[i].team === teamName) {
                    lastTeamEntryIndex = i;
                    break;
                }
            }
            
            if (lastTeamEntryIndex === -1) return;
            
            currentGame.history.splice(lastTeamEntryIndex, 1);
            recalculateScoresFromHistory();
            updateGameDisplay();
        }

        function recalculateScoresFromHistory() {
            currentGame.score1 = 0;
            currentGame.score2 = 0;
            
            currentGame.history.forEach(entry => {
                let isTeam1;
                if (currentGame.gameMode === 'team') {
                    isTeam1 = entry.team === `${currentGame.team1.player1} & ${currentGame.team1.player2}`;
                } else {
                    isTeam1 = entry.team === currentGame.player1;
                }
                
                if (isTeam1) {
                    currentGame.score1 += entry.points;
                } else {
                    currentGame.score2 += entry.points;
                }
                
                entry.team1Score = currentGame.score1;
                entry.team2Score = currentGame.score2;
            });
        }
        
        // NEW: Checks for comeback king achievement
        function checkForComeback(winnerTeamNum) {
            if (!currentGame) return false;
            
            for(const entry of currentGame.history) {
                if(winnerTeamNum === 1) { // Team 1 won
                    if (entry.team2Score - entry.team1Score >= 50) return true;
                } else { // Team 2 won
                    if (entry.team1Score - entry.team2Score >= 50) return true;
                }
            }
            return false;
        }

        function declarePetaroll() {
            if (!currentGame) return;
            
            currentGame.ended = true;
            
            let winner, loser, winnerScore, loserScore, winnerName, loserName, winnerTeamNum;
            
            if (currentGame.gameMode === 'team') {
                winnerTeamNum = currentGame.score1 > currentGame.score2 ? 1 : 2;
                winner = winnerTeamNum === 1 ? currentGame.team1 : currentGame.team2;
                loser = winnerTeamNum === 1 ? currentGame.team2 : currentGame.team1;
                winnerScore = Math.max(currentGame.score1, currentGame.score2);
                loserScore = Math.min(currentGame.score1, currentGame.score2);
                winnerName = `${winner.player1} & ${winner.player2}`;
                loserName = `${loser.player1} & ${loser.player2}`;
            } else {
                winnerTeamNum = currentGame.score1 > currentGame.score2 ? 1 : 2;
                winner = winnerTeamNum === 1 ? currentGame.player1 : currentGame.player2;
                loser = winnerTeamNum === 1 ? currentGame.player2 : currentGame.player1;
                winnerScore = Math.max(currentGame.score1, currentGame.score2);
                loserScore = Math.min(currentGame.score1, currentGame.score2);
                winnerName = winner;
                loserName = loser;
            }

            const wasComeback = checkForComeback(winnerTeamNum);

            const gameRecord = {
                id: Date.now(),
                gameMode: currentGame.gameMode,
                winner: currentGame.gameMode === 'team' ? winner.id : winner,
                loser: currentGame.gameMode === 'team' ? loser.id : loser,
                winnerScore,
                loserScore,
                date: new Date().toISOString(),
                duration: new Date().getTime() - currentGame.startTime.getTime(),
                isPetaroll: true,
                gameValue: 2,
                wasComeback: wasComeback
            };
            
            games.push(gameRecord);
            localStorage.setItem('dominoGames', JSON.stringify(games));

            const loserId = currentGame.gameMode === 'team' ? loser.id : loser;
            const previousPetarolls = games.filter(g => g.loser === loserId && g.isPetaroll).length;
            
            let messageHtml = `
                <div class="text-3xl font-bold text-orange-600 mb-4">🔥 PETAROLL! 🔥</div>
                <div class="text-xl mb-2"><strong>${winnerName}</strong></div>
                <div class="text-lg mb-2">PETAROLLED</div>
                <div class="text-xl mb-2"><strong>${loserName}</strong></div>
                <div class="text-lg mb-2">Final Score: ${winnerScore} - ${loserScore}</div>
                <div class="mt-4 p-3 bg-red-100 dark:bg-red-900 rounded-lg">
                    <div class="text-red-800 dark:text-red-200">
                        ${loserName} has been PETAROLLED <strong>${previousPetarolls}</strong> time${previousPetarolls > 1 ? 's' : ''}!
                    </div>
                </div>
                <div class="mt-4">
                    <span class="petaroll-badge text-xl">This counts as 2 WINS!</span>
                </div>
            `;
            document.getElementById('winMessage').innerHTML = messageHtml;
            playSound('petaroll');

            if (currentGame.score1 > currentGame.score2) matchWins1 += 2; else matchWins2 += 2;
            handleMatchEnd(winnerName, gameRecord);
        }

        function declareWinner() {
            if (!currentGame) return;
            currentGame.ended = true;

            let winner, loser, winnerScore, loserScore, winnerName, winnerTeamNum;

            if (currentGame.gameMode === 'team') {
                winnerTeamNum = currentGame.score1 >= 150 ? 1 : 2;
                winner = winnerTeamNum === 1 ? currentGame.team1 : currentGame.team2;
                loser = winnerTeamNum === 1 ? currentGame.team2 : currentGame.team1;
                winnerName = `${winner.player1} & ${winner.player2}`;
            } else {
                winnerTeamNum = currentGame.score1 >= 150 ? 1 : 2;
                winner = winnerTeamNum === 1 ? currentGame.player1 : currentGame.player2;
                loser = winnerTeamNum === 1 ? currentGame.player2 : currentGame.player1;
                winnerName = winner;
            }
            winnerScore = Math.max(currentGame.score1, currentGame.score2);
            loserScore = Math.min(currentGame.score1, currentGame.score2);
            
            const wasComeback = checkForComeback(winnerTeamNum);

            const gameRecord = {
                id: Date.now(),
                gameMode: currentGame.gameMode,
                winner: currentGame.gameMode === 'team' ? winner.id : winner,
                loser: currentGame.gameMode === 'team' ? loser.id : loser,
                winnerScore,
                loserScore,
                date: new Date().toISOString(),
                duration: new Date().getTime() - currentGame.startTime.getTime(),
                isPetaroll: false,
                gameValue: 1,
                wasComeback: wasComeback
            };
            
            games.push(gameRecord);
            localStorage.setItem('dominoGames', JSON.stringify(games));

            if (currentGame.score1 > currentGame.score2) matchWins1++; else matchWins2++;
            document.getElementById('winMessage').innerHTML = `<strong>${winnerName}</strong> wins!<br>Final Score: ${winnerScore} - ${loserScore}`;
            handleMatchEnd(winnerName, gameRecord);
        }

        function handleMatchEnd(winnerName, gameRecord) {
            updateMatchScoreDisplay();
            const requiredWins = Math.ceil(bestOf / 2);
            let seriesInfo = `<div class="mt-2">Series Score: ${matchWins1} - ${matchWins2}</div>`;
            if (matchWins1 >= requiredWins || matchWins2 >= requiredWins) {
                matchOver = true;
                seriesInfo += `<div class="mt-2 font-bold">${winnerName} wins the best of ${bestOf}!</div>`;
                document.getElementById('playAgainBtn').classList.add('hidden');
            } else {
                document.getElementById('playAgainBtn').classList.remove('hidden');
            }
            document.getElementById('winMessage').innerHTML += seriesInfo;

            playSound('win');
            checkAllAchievements(gameRecord);
            refreshAllData();
            document.getElementById('winModal').classList.remove('hidden');
            disableScoreButtons();
        }

        function playAgain() {
            if (matchOver) {
                closeWinModal();
                endGame();
            } else {
                resetGame();
                closeWinModal();
            }
        }

        function closeWinModal() {
            document.getElementById('winModal').classList.add('hidden');
        }

        function resetGame() {
            if (currentGame) {
                currentGame.score1 = 0;
                currentGame.score2 = 0;
                currentGame.history = [];
                currentGame.ended = false;
                document.getElementById('petarollAlert').classList.add('hidden');
                document.getElementById('customScore1').value = '';
                document.getElementById('customScore2').value = '';
                document.getElementById('confirmScoreContainer').classList.add('hidden');
                document.getElementById('gameControls').classList.remove('hidden');
                updateGameDisplay();
                enableScoreButtons();
            }
        }

        function endGame() {
            currentGame = null;
            currentGameMode = null;
            matchWins1 = 0;
            matchWins2 = 0;
            matchOver = false;
            updateMatchScoreDisplay();
            document.getElementById('gameSetup').classList.add('hidden');
            document.getElementById('liveGame').classList.add('hidden');
            document.getElementById('scoreHistory').innerHTML = '';
            document.getElementById('petarollAlert').classList.add('hidden');
            document.getElementById('confirmScoreContainer').classList.add('hidden');
            document.getElementById('gameControls').classList.remove('hidden');
            
            // Clear all input fields
            document.getElementById('gameTeam1Player1Input').value = '';
            document.getElementById('gameTeam1Player2Input').value = '';
            document.getElementById('gameTeam2Player1Input').value = '';
            document.getElementById('gameTeam2Player2Input').value = '';
            document.getElementById('gameTeam1Selection').value = '';
            document.getElementById('gameTeam2Selection').value = '';
            document.getElementById('player1Select').value = '';
            document.getElementById('player2Select').value = '';
            
            loadLiveSection();
        }

        function disableScoreButtons() {
            document.querySelectorAll('.score-btn, .custom-score-input + button, .custom-score-input ~ button').forEach(button => {
                button.disabled = true;
            });
        }

        function enableScoreButtons() {
            document.querySelectorAll('.score-btn, .custom-score-input + button, .custom-score-input ~ button').forEach(button => {
                button.disabled = false;
            });
        }

        // Timer functions
        function startTurnTimer() {
            const timeInput = document.getElementById('turnTimeInput');
            const timeLimit = Math.min(parseInt(timeInput.value) || 60, 60);
            remainingTime = timeLimit;
            
            if (turnTimer) clearInterval(turnTimer);
            
            turnTimer = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                
                if (remainingTime <= 0) {
                    stopTurnTimer();
                    showToast("Time's up!");
                }
            }, 1000);
            
            updateTimerDisplay();
        }
        
        function stopTurnTimer() {
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
            document.getElementById('turnTimerDisplay').textContent = '--';
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('turnTimerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Players Section
        function loadPlayers() {
            const playersHtml = players.map(player => {
                const wins = games.filter(g => {
                    if (g.gameMode === 'single') return g.winner === player.name;
                    const team = teams.find(t => t.id === g.winner);
                    return team && (team.player1 === player.name || team.player2 === player.name);
                }).reduce((sum, g) => sum + (g.gameValue || 1), 0);
                
                const losses = games.filter(g => {
                    if (g.gameMode === 'single') return g.loser === player.name;
                    const team = teams.find(t => t.id === g.loser);
                    return team && (team.player1 === player.name || team.player2 === player.name);
                }).reduce((sum, g) => sum + (g.gameValue || 1), 0);

                const totalGames = wins + losses;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                
                return `
                    <div class="domino-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">${player.name}</h3>
                            <button onclick="deletePlayer('${player.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-green-600">${wins}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Wins</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-red-600">${losses}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Losses</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-blue-600">${winRate}%</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Win Rate</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('playersList').innerHTML = playersHtml || '<div class="col-span-full text-center text-gray-500 dark:text-gray-400">No players added yet.</div>';
        }

        function showCreatePlayerForm() {
            document.getElementById('createPlayerForm').classList.remove('hidden');
        }

        function hideCreatePlayerForm() {
            document.getElementById('createPlayerForm').classList.add('hidden');
            document.getElementById('newPlayerName').value = '';
        }

        function createPlayer() {
            const playerName = document.getElementById('newPlayerName').value.trim();
            if (!playerName) {
                showToast('Please enter a player name');
                return;
            }
            
            addPlayerIfNotExists(playerName);
            hideCreatePlayerForm();
            loadPlayers();
        }

        function addPlayerIfNotExists(playerName) {
            if (!playerName) return;
            const nameExists = players.some(p => p.name.toLowerCase() === playerName.toLowerCase());
            if (!nameExists) {
                const newPlayer = { id: Date.now().toString(), name: playerName };
                players.push(newPlayer);
                localStorage.setItem('dominoPlayers', JSON.stringify(players));
            }
        }

        function deletePlayer(playerId) {
            const playerToDelete = players.find(p => p.id === playerId);
            if (!playerToDelete) return;
            
            showConfirmModal(
                'Delete Player',
                `Are you sure you want to delete ${playerToDelete.name}? This will also remove them from any teams.`,
                () => {
                    const isPlayerInTeam = teams.some(team => team.player1 === playerToDelete.name || team.player2 === playerToDelete.name);
                    if (isPlayerInTeam) {
                        teams = teams.filter(team => team.player1 !== playerToDelete.name && team.player2 !== playerToDelete.name);
                        localStorage.setItem('dominoTeams', JSON.stringify(teams));
                    }

                    players = players.filter(p => p.id !== playerId);
                    localStorage.setItem('dominoPlayers', JSON.stringify(players));
                    loadPlayers();
                    if (currentSection === 'teams') loadTeams();
                    showToast(`${playerToDelete.name} has been deleted.`);
                }
            );
        }

        // Teams Section
        function loadTeams() {
            const teamsHtml = teams.map(team => {
                const wins = games.filter(g => g.winner === team.id).reduce((sum, g) => sum + (g.gameValue || 1), 0);
                const losses = games.filter(g => g.loser === team.id).reduce((sum, g) => sum + (g.gameValue || 1), 0);
                const petarolls = games.filter(g => g.winner === team.id && g.isPetaroll).length;
                const gotPetarolled = games.filter(g => g.loser === team.id && g.isPetaroll).length;
                const totalGames = wins + losses;
                const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) : 0;
                
                return `
                    <div class="domino-card p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold">${team.player1} & ${team.player2}</h3>
                            <button onclick="deleteTeam('${team.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-green-600">${wins}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Wins</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-red-600">${losses}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Losses</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-blue-600">${winRate}%</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">Win Rate</div>
                            </div>
                        </div>
                        <div class="mt-3 text-center space-y-1">
                            ${petarolls > 0 ? `<span class="petaroll-badge">${petarolls} PETAROLLS</span>` : ''}
                            ${gotPetarolled > 0 ? `<span class="petarolled-badge">PETAROLLED ${gotPetarolled}x</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('teamsList').innerHTML = teamsHtml || '<div class="col-span-full text-center text-gray-500 dark:text-gray-400">No teams created yet</div>';
        }

        function showCreateTeam() {
            document.getElementById('createTeamForm').classList.remove('hidden');
        }

        function hideCreateTeam() {
            document.getElementById('createTeamForm').classList.add('hidden');
            document.getElementById('teamPlayer1Input').value = '';
            document.getElementById('teamPlayer2Input').value = '';
        }

        function createTeam() {
            const player1Name = document.getElementById('teamPlayer1Input').value.trim();
            const player2Name = document.getElementById('teamPlayer2Input').value.trim();
            
            if (!player1Name || !player2Name) {
                showToast('Please enter both player names');
                return;
            }

            if (player1Name.toLowerCase() === player2Name.toLowerCase()) {
                showToast('Please enter two different player names');
                return;
            }

            addPlayerIfNotExists(player1Name);
            addPlayerIfNotExists(player2Name);
            
            findOrCreateTeam(player1Name, player2Name);
            
            hideCreateTeam();
            loadTeams();
        }

        function findOrCreateTeam(player1Name, player2Name) {
            const sortedNames = [player1Name, player2Name].sort();
            
            let existingTeam = teams.find(team => 
                team.player1 === sortedNames[0] && team.player2 === sortedNames[1]
            );

            if (existingTeam) {
                return existingTeam;
            } else {
                const newTeam = {
                    id: Date.now().toString(),
                    player1: sortedNames[0],
                    player2: sortedNames[1],
                };
                teams.push(newTeam);
                localStorage.setItem('dominoTeams', JSON.stringify(teams));
                return newTeam;
            }
        }

        function deleteTeam(teamId) {
            showConfirmModal(
                'Delete Team',
                'Are you sure you want to delete this team? This will not delete the players.',
                () => {
                    teams = teams.filter(t => t.id !== teamId);
                    localStorage.setItem('dominoTeams', JSON.stringify(teams));
                    loadTeams();
                    showToast('Team deleted successfully.');
                }
            );
        }

        // Leaderboard section
        function loadLeaderboard() {
            document.getElementById('lastUpdatedTime').textContent = new Date().toLocaleString();
            showLeaderboard('daily');
        }

        function showLeaderboard(period) {
            currentPeriod = period;
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('bg-blue-500', 'text-white');
                tab.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            });
            
            const activeTab = document.querySelector(`[onclick="showLeaderboard('${period}')"]`);
            activeTab.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
            activeTab.classList.add('bg-blue-500', 'text-white');
            
            games = JSON.parse(localStorage.getItem('dominoGames')) || [];
            
            loadTeamRankings(period);
            loadPlayerStats(period);
            loadOpponentComparison();
            loadStreaks(period);
            loadPetarollLeaders(period);
        }

        function loadTeamRankings(period) {
            const filteredGames = filterGamesByPeriod(games, period);
            const teamStats = {};
            
            teams.forEach(team => {
                teamStats[team.id] = { name: `${team.player1} & ${team.player2}`, wins: 0, losses: 0, petarolls: 0, gotPetarolled: 0 };
            });
            
            filteredGames.forEach(game => {
                if (game.gameMode === 'team') {
                    if (teamStats[game.winner]) {
                        teamStats[game.winner].wins += game.gameValue || 1;
                        if (game.isPetaroll) teamStats[game.winner].petarolls++;
                    }
                    if (teamStats[game.loser]) {
                        teamStats[game.loser].losses += game.gameValue || 1;
                        if (game.isPetaroll) teamStats[game.loser].gotPetarolled++;
                    }
                }
            });
            
            const rankings = Object.values(teamStats)
                .filter(stat => stat.wins > 0 || stat.losses > 0)
                .sort((a, b) => (b.wins / (b.wins + b.losses) || 0) - (a.wins / (a.wins + a.losses) || 0) || b.wins - a.wins);
            
            const rankingsHtml = rankings.map((stat, index) => {
                const total = stat.wins + stat.losses;
                const winRate = total > 0 ? ((stat.wins / total) * 100).toFixed(1) : 0;
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">${medal}</span>
                            <div>
                                <div class="font-bold">${stat.name}</div>
                                <div>
                                    ${stat.petarolls > 0 ? `<span class="petaroll-badge">${stat.petarolls} PETAROLL${stat.petarolls > 1 ? 'S' : ''}</span>` : ''}
                                    ${stat.gotPetarolled > 0 ? `<span class="petarolled-badge">PETAROLLED ${stat.gotPetarolled}x</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">${stat.wins}W - ${stat.losses}L</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${winRate}% Win Rate</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('teamRankings').innerHTML = rankingsHtml || '<p class="text-gray-500 dark:text-gray-400">No games played in this period</p>';
        }

        function loadPlayerStats(period) {
            const filteredGames = filterGamesByPeriod(games, period);
            const playerStats = {};
            
            players.forEach(player => {
                playerStats[player.name] = { name: player.name, wins: 0, losses: 0, petarolls: 0, gotPetarolled: 0 };
            });
            
            filteredGames.forEach(game => {
                if (game.gameMode === 'single') {
                    if (playerStats[game.winner]) {
                        playerStats[game.winner].wins += game.gameValue || 1;
                        if (game.isPetaroll) playerStats[game.winner].petarolls++;
                    }
                    if (playerStats[game.loser]) {
                        playerStats[game.loser].losses += game.gameValue || 1;
                        if (game.isPetaroll) playerStats[game.loser].gotPetarolled++;
                    }
                } else {
                    const winnerTeam = teams.find(t => t.id === game.winner);
                    const loserTeam = teams.find(t => t.id === game.loser);
                    
                    if (winnerTeam) {
                        [winnerTeam.player1, winnerTeam.player2].forEach(p => {
                            if(playerStats[p]) {
                                playerStats[p].wins += game.gameValue || 1;
                                if (game.isPetaroll) playerStats[p].petarolls++;
                            }
                        });
                    }
                    if (loserTeam) {
                        [loserTeam.player1, loserTeam.player2].forEach(p => {
                            if(playerStats[p]) {
                                playerStats[p].losses += game.gameValue || 1;
                                if (game.isPetaroll) playerStats[p].gotPetarolled++;
                            }
                        });
                    }
                }
            });
            
            const playerRankings = Object.values(playerStats)
                .filter(stat => stat.wins > 0 || stat.losses > 0)
                .sort((a, b) => (b.wins / (b.wins + b.losses) || 0) - (a.wins / (a.wins + a.losses) || 0) || b.wins - a.wins);
            
            const playersHtml = playerRankings.slice(0, 10).map((stat, index) => {
                const total = stat.wins + stat.losses;
                const winRate = total > 0 ? ((stat.wins / total) * 100).toFixed(1) : 0;
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${medal}</span>
                            <div>
                                <div class="font-medium">${stat.name}</div>
                                <div>
                                    ${stat.petarolls > 0 ? `<span class="petaroll-badge">${stat.petarolls} PETAROLL${stat.petarolls > 1 ? 'S' : ''}</span>` : ''}
                                    ${stat.gotPetarolled > 0 ? `<span class="petarolled-badge">PETAROLLED ${stat.gotPetarolled}x</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <div class="font-bold">${stat.wins}W - ${stat.losses}L</div>
                            <div class="text-gray-500 dark:text-gray-400">${winRate}%</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('playerStats').innerHTML = playersHtml || '<p class="text-gray-500 dark:text-gray-400">No games played in this period</p>';
        }

        function loadOpponentComparison() {
            const select1 = document.getElementById('comparison-select1');
            const select2 = document.getElementById('comparison-select2');
            
            let options = '<option value="">Select Player/Team</option>';
            players.forEach(p => options += `<option value="player:${p.name}">${p.name}</option>`);
            teams.forEach(t => options += `<option value="team:${t.id}">${t.player1} & ${t.player2}</option>`);
            
            select1.innerHTML = options;
            select2.innerHTML = options;
            
            document.getElementById('comparison-period-selector').addEventListener('change', runOpponentComparison);
            resetOpponentComparison();
        }

        function resetOpponentComparison() {
            document.getElementById('comparison-select1').value = '';
            document.getElementById('comparison-select2').value = '';
            document.getElementById('comparison-results').innerHTML = '';
        }

        function getOverallStats(entityId, period) {
            const [type, id] = entityId.split(':');
            const relevantGames = filterGamesByPeriod(games, period);
            let wins = 0, losses = 0, petarollsGiven = 0, petarolled = 0;

            relevantGames.forEach(game => {
                if (type === 'player') {
                    if(game.gameMode === 'single') {
                        if(game.winner === id) {
                            wins += game.gameValue || 1;
                            if(game.isPetaroll) petarollsGiven++;
                        }
                        if(game.loser === id) {
                            losses += game.gameValue || 1;
                            if(game.isPetaroll) petarolled++;
                        }
                    } else { // team game
                        const winnerTeam = teams.find(t => t.id === game.winner);
                        const loserTeam = teams.find(t => t.id === game.loser);
                        if(winnerTeam && (winnerTeam.player1 === id || winnerTeam.player2 === id)) {
                            wins += game.gameValue || 1;
                            if(game.isPetaroll) petarollsGiven++;
                        }
                        if(loserTeam && (loserTeam.player1 === id || loserTeam.player2 === id)) {
                            losses += game.gameValue || 1;
                            if(game.isPetaroll) petarolled++;
                        }
                    }
                } else { // team
                    if(game.gameMode === 'team') {
                         if(game.winner === id) {
                            wins += game.gameValue || 1;
                            if(game.isPetaroll) petarollsGiven++;
                        }
                        if(game.loser === id) {
                            losses += game.gameValue || 1;
                            if(game.isPetaroll) petarolled++;
                        }
                    }
                }
            });
            const totalGames = wins + losses;
            const winRate = totalGames > 0 ? ((wins / totalGames) * 100).toFixed(1) + '%' : 'N/A';

            return { wins, losses, winRate, petarollsGiven, petarolled };
        }

        function runOpponentComparison() {
            const select1Val = document.getElementById('comparison-select1').value;
            const select2Val = document.getElementById('comparison-select2').value;
            const period = document.querySelector('input[name="comparison-period"]:checked').value;
            const resultsDiv = document.getElementById('comparison-results');

            if (!select1Val || !select2Val) {
                resultsDiv.innerHTML = '';
                return;
            }

            if (select1Val === select2Val) {
                resultsDiv.innerHTML = '<p class="text-sm text-red-500">Please select two different opponents.</p>';
                return;
            }

            const stats1 = getOverallStats(select1Val, period);
            const stats2 = getOverallStats(select2Val, period);

            const name1 = select1Val.startsWith('player:') ? select1Val.split(':')[1] : teams.find(t=>t.id===select1Val.split(':')[1]).player1 + ' & ' + teams.find(t=>t.id===select1Val.split(':')[1]).player2;
            const name2 = select2Val.startsWith('player:') ? select2Val.split(':')[1] : teams.find(t=>t.id===select1Val.split(':')[1]).player1 + ' & ' + teams.find(t=>t.id===select1Val.split(':')[1]).player2;

            resultsDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center mt-2">
                    <div>
                        <div class="font-bold">${name1}</div>
                        <div class="text-sm">${stats1.wins}W - ${stats1.losses}L</div>
                        <div class="text-xs text-gray-500">${stats1.winRate}</div>
                        <div class="text-xs mt-1">Petarolls: ${stats1.petarollsGiven}</div>
                        <div class="text-xs">Petarolled: ${stats1.petarolled}</div>
                    </div>
                    <div>
                        <div class="font-bold">${name2}</div>
                        <div class="text-sm">${stats2.wins}W - ${stats2.losses}L</div>
                        <div class="text-xs text-gray-500">${stats2.winRate}</div>
                        <div class="text-xs mt-1">Petarolls: ${stats2.petarollsGiven}</div>
                        <div class="text-xs">Petarolled: ${stats2.petarolled}</div>
                    </div>
                </div>
            `;
        }

        function loadStreaks(period) {
            const filteredGames = filterGamesByPeriod(games, period).sort((a,b) => new Date(a.date) - new Date(b.date));
            const currentStreaks = {};

            const allEntities = [
                ...players.map(p => ({ id: `player:${p.name}`, name: p.name, type: 'player' })),
                ...teams.map(t => ({ id: `team:${t.id}`, name: `${t.player1} & ${t.player2}`, type: 'team' }))
            ];

            allEntities.forEach(e => {
                currentStreaks[e.id] = { name: e.name, currentStreak: 0, type: 'none' };
            });

            filteredGames.forEach(game => {
                const winnerId = game.gameMode === 'single' ? `player:${game.winner}` : `team:${game.winner}`;
                const loserId = game.gameMode === 'single' ? `player:${game.loser}` : `team:${game.loser}`;
                
                if (currentStreaks[winnerId]) {
                    if (currentStreaks[winnerId].type === 'win') {
                        currentStreaks[winnerId].currentStreak++;
                    } else {
                        currentStreaks[winnerId].type = 'win';
                        currentStreaks[winnerId].currentStreak = 1;
                    }
                }

                 if (currentStreaks[loserId]) {
                    if (currentStreaks[loserId].type === 'loss') {
                        currentStreaks[loserId].currentStreak++;
                    } else {
                        currentStreaks[loserId].type = 'loss';
                        currentStreaks[loserId].currentStreak = 1;
                    }
                }
            });

            const winningStreaks = Object.values(currentStreaks).filter(s => s.type === 'win' && s.currentStreak > 1).sort((a,b) => b.currentStreak - a.currentStreak);
            const losingStreaks = Object.values(currentStreaks).filter(s => s.type === 'loss' && s.currentStreak > 1).sort((a,b) => b.currentStreak - a.currentStreak);

            let html = '<div><h4 class="font-semibold text-green-500 dark:text-green-400">Winning Streaks</h4>';
            if(winningStreaks.length > 0) {
                html += winningStreaks.slice(0,3).map(s => `<div class="text-sm">${s.name}: <span class="font-semibold">${s.currentStreak} wins</span></div>`).join('');
            } else {
                html += '<div class="text-sm text-gray-500 dark:text-gray-400">None</div>';
            }
            html += '</div>';

            html += '<div class="mt-4"><h4 class="font-semibold text-red-500 dark:text-red-400">Losing Streaks</h4>';
            if(losingStreaks.length > 0) {
                html += losingStreaks.slice(0,3).map(s => `<div class="text-sm">${s.name}: <span class="font-semibold">${s.currentStreak} losses</span></div>`).join('');
            } else {
                 html += '<div class="text-sm text-gray-500 dark:text-gray-400">None</div>';
            }
            html += '</div>';
            
            document.getElementById('streaks-slumps-list').innerHTML = html;
        }

        function loadPetarollLeaders(period) {
            const filteredGames = filterGamesByPeriod(games, period).filter(g => g.isPetaroll);
            const petarollers = {};
            const petarolled = {};

            const allEntities = [
                ...players.map(p => ({ id: `player:${p.name}`, name: p.name, type: 'player' })),
                ...teams.map(t => ({ id: `team:${t.id}`, name: `${t.player1} & ${t.player2}`, type: 'team' }))
            ];

            allEntities.forEach(e => {
                petarollers[e.id] = { name: e.name, count: 0 };
                petarolled[e.id] = { name: e.name, count: 0 };
            });

            filteredGames.forEach(game => {
                const winnerId = game.gameMode === 'single' ? `player:${game.winner}` : `team:${game.winner}`;
                const loserId = game.gameMode === 'single' ? `player:${game.loser}` : `team:${game.loser}`;
                if(petarollers[winnerId]) petarollers[winnerId].count++;
                if(petarolled[loserId]) petarolled[loserId].count++;
            });

            const topPetarollers = Object.values(petarollers).filter(p => p.count > 0).sort((a,b) => b.count - a.count);
            const topPetarolled = Object.values(petarolled).filter(p => p.count > 0).sort((a,b) => b.count - a.count);

            let html = '<div><h4 class="font-semibold text-yellow-500 dark:text-yellow-400">Most Petarolls Given</h4>';
            if(topPetarollers.length > 0) {
                html += topPetarollers.slice(0,3).map(p => `<div class="text-sm">${p.name}: <span class="font-semibold">${p.count}</span></div>`).join('');
            } else {
                html += '<div class="text-sm text-gray-500 dark:text-gray-400">None</div>';
            }
            html += '</div>';

            html += '<div class="mt-4"><h4 class="font-semibold text-red-500 dark:text-red-400">Most Petarolled</h4>';
             if(topPetarolled.length > 0) {
                html += topPetarolled.slice(0,3).map(p => `<div class="text-sm">${p.name}: <span class="font-semibold">${p.count}</span></div>`).join('');
            } else {
                 html += '<div class="text-sm text-gray-500 dark:text-gray-400">None</div>';
            }
            html += '</div>';

            document.getElementById('petaroll-leaders-list').innerHTML = html;
        }

        function filterGamesByPeriod(games, period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (period) {
                case 'daily':
                    return games.filter(game => new Date(game.date) >= today);
                case 'weekly':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return games.filter(game => new Date(game.date) >= weekAgo);
                case 'monthly':
                    const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    return games.filter(game => new Date(game.date) >= monthAgo);
                case 'alltime':
                default:
                    return games;
            }
        }

        // Voice command functionality
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('micBtn').style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const micBtn = document.getElementById('micBtn');

            recognition.onstart = () => {
                isMicOn = true;
                micBtn.classList.add('animate-pulse', 'bg-red-500');
                micBtn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>Stop';
            };

            recognition.onend = () => {
                isMicOn = false;
                micBtn.classList.remove('animate-pulse', 'bg-red-500');
                micBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Voice';
            };

            recognition.onerror = (event) => {
                document.getElementById('voiceOutput').textContent = `Error: ${event.error}`;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                document.getElementById('voiceOutput').textContent = `Heard: "${transcript}"`;
                parseVoiceCommand(transcript);
            };
        }

        function toggleMic() {
            if (!recognition) setupSpeechRecognition();
            if (isMicOn) {
                recognition.stop();
            } else {
                if(currentGame) {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error("Speech recognition error:", e);
                    }
                }
                else showToast("Please start a game first.");
            }
        }

        function parseVoiceCommand(command) {
            const outputEl = document.getElementById('voiceOutput');
            const scoreMatch = command.match(/\d+/);

            if (!scoreMatch) {
                outputEl.textContent += ' - No score found in command.';
                return;
            }
            const points = parseInt(scoreMatch[0], 10);

            let team = 0;
            // Check for Team 2 (Red) keywords first
            if (command.includes('red') || command.includes('read') || command.includes('team 2') || command.includes('player 2')) {
                team = 2;
            } 
            // Check for Team 1 (Blue) keywords
            else if (command.includes('blue') || command.includes('team 1') || command.includes('player 1')) {
                team = 1;
            }

            if (team && points) {
                const customScoreInput = document.getElementById(`customScore${team}`);
                if (customScoreInput) {
                    customScoreInput.value = points;
                    addCustomScore(team);
                    outputEl.textContent += ` - Added ${points} to Team ${team}.`;
                }
            } else {
                outputEl.textContent += ' - Could not determine the team. Please say "blue" or "red".';
            }
        }

        // NEW: Custom Modals and Toasts
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            
            // Clone and replace the button to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                closeConfirmModal();
            });
            
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }


        // Initialize app
        function initApp() {
            initTheme();
            initAudio(); // Initialize the audio context
            showSection('home');
            setupSpeechRecognition();
        }

        // Start the app
        initApp();
 
    

</body>
</hml>
  

  

        
